---
import { concatURL } from '@aracna/core'
import type { Dirent } from 'fs'
import { readdir } from 'fs/promises'
import type { DocsPageMDXInstance, DocsPageMDXInstanceFrontmatter } from '../definitions/interfaces'
import type { SidebarItemProps } from '../definitions/props'
import { mapDirName } from '../utils/fs.utils'
import { SidebarItem } from './SidebarItem'

const globs = await Astro.glob<DocsPageMDXInstanceFrontmatter>('../pages/docs/**/*.mdx')

async function getItems(folders: string[] = ['docs']): Promise<SidebarItemProps[]> {
  let dirs: Dirent[], items: SidebarItemProps[]

  dirs = await readdir(concatURL(process.env.PWD ?? '', 'src/pages', folders.join('/')), { withFileTypes: true })
  items = []

  for (let i = 0; i < dirs.length; i++) {
    let dir: Dirent, item: SidebarItemProps

    dir = dirs[i]

    if (dir.isDirectory()) {
      item = {
        href: concatURL('/', folders.join('/'), dir.name),
        items: await getItems([...folders, dir.name]),
        order: i,
        title: mapDirName(dir.name)
      }

      item.expanded = Astro.url.pathname.includes(item.href)

      items.push(item)
    }

    if (dir.isFile()) {
      let glob: DocsPageMDXInstance | undefined

      glob = globs.find((glob: DocsPageMDXInstance) => glob.file.includes(concatURL(folders.join('/'), dir.name)))
      if (!glob) continue

      if (glob.frontmatter.draft) {
        continue
      }

      item = {
        href: concatURL('/', folders.join('/'), dir.name).replace('.mdx', ''),
        order: glob.frontmatter.order ?? i,
        title: glob.frontmatter.title
      }

      item.active = item.href === Astro.url.pathname

      items.push(item)
    }
  }

  items = items.sort((a: SidebarItemProps, b: SidebarItemProps) => a.order - b.order)

  return items
}

const items: SidebarItemProps[] = await getItems()
---

<div class='w-72 max-h-screen-minus-header hidden xl:flex flex-col p-4 overflow-y-auto border-r-2 border-slate-800' style='min-height: calc(100vh - 96px)'>
  {items.map((props: SidebarItemProps) => <SidebarItem {...props} client:load />)}
</div>
